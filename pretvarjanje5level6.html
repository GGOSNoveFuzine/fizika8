<!DOCTYPE html>
<html lang="sl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pretvarjanje enot — 5 stopenj (5 nalog)</title>
<style>
  :root{
    --bg:#0f1320; --fg:#e9eef7; --muted:#a9b6cc; --ok:#11c480; --bad:#ff5d5d; --hint:#4ea1ff;
    --card:#171c2c; --btn:#243153; --btn2:#2a3c6a; --accent:#8ab4ff;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--fg);}
  header{padding:16px 12px; background:linear-gradient(180deg,#11172a,#0f1320);} 
  h1{margin:0 0 6px 0; font-size:20px}
  .subtitle{color:var(--muted); font-size:13px}
  main{padding:12px; max-width:1100px; margin:0 auto}
  .controls{display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:8px; align-items:end}
  label{font-size:13px; color:var(--muted); display:block; margin-bottom:4px}
  select,button{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2b375a; background:var(--btn); color:var(--fg);} 
  button{cursor:pointer; background:var(--btn2); border:1px solid #3a4c7d;}
  button.primary{background:var(--accent); color:#0b1222; border-color:#95beff; font-weight:600}
  button:disabled{opacity:.5; cursor:not-allowed}
  .grid{margin-top:12px; display:grid; gap:8px}

  .row{ background:var(--card); border:1px solid #233055; border-radius:14px; padding:10px;
    display:grid; grid-template-columns: 1fr 170px auto auto auto auto; gap:8px; align-items:center }
  .expr{font-variant-numeric:tabular-nums; font-size:15px}
  .eq{opacity:.7}
  input.answer{ width:100%; padding:9px 10px; border-radius:10px; border:1px solid #2b375a; background:#0e1322; color:var(--fg); font-size:15px }
  .chip{padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #2b375a; background:#0f1a33; color:var(--muted); white-space:nowrap}
  .hint-btn,.solve-btn{padding:8px 10px; border-radius:10px; border:1px dashed #39507e; background:#0d1730; color:var(--hint)}
  details.hint{grid-column:1 / -1; background:#0d1730; border:1px dashed #39507e; border-radius:12px; padding:8px 10px}
  details.hint > summary{cursor:pointer; color:var(--hint)}
  .feedback{margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  .pill{padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #2b375a; background:#0f1a33}
  .ok{color:var(--ok); border-color:#1f6f58}
  .bad{color:var(--bad); border-color:#7d2b2b}
  .info{color:#c2d3ff}

  .verdict{ margin-left:6px; padding:4px 8px; border-radius:999px; font-weight:700; font-size:12px; border:1px solid transparent; user-select:none }
  .verdict.ok{background:rgba(17,196,128,.15); color:var(--ok); border-color:#1f6f58}
  .verdict.bad{background:rgba(255,93,93,.15); color:var(--bad); border-color:#7d2b2b}

  .solution{ grid-column:1 / -1; padding:8px 10px; border-radius:10px; background:#0e1631; border:1px dashed #3b4f84; display:none; color:#d5e2ff }
  .solution b{color:#fff}

  @media (max-width:920px){ .controls{grid-template-columns:1fr 1fr 1fr} }
  @media (max-width:720px){ .controls{grid-template-columns:1fr; gap:10px} .row{grid-template-columns:1fr 1fr auto auto auto auto; gap:6px} .expr{font-size:14px} input.answer{font-size:14px} }
</style>
</head>
<body>
  <header>
    <h1>Pretvarjanje enot</h1>
    <div class="subtitle">5 nalog na serijo • 5 stopenj težavnosti • Namigi / Rešitve • Decimalna <b>vejica</b> (npr. 1,25)</div>
  </header>

  <main>
    <section class="controls">
      <div>
        <label for="category">Vrsta enote</label>
        <select id="category">
          <option value="masa">Masa</option>
          <option value="dolzina">Dolžina</option>
          <option value="povrsina">Površina</option>
          <option value="prostornina">Prostornina</option>
          <option value="cas">Čas</option>
        </select>
      </div>
      <div>
        <label for="difficulty">Težavnost</label>
        <select id="difficulty">
          <option value="A1">Zelo lahko</option>
          <option value="A2">Lahko</option>
          <option value="B1">Srednje</option>
          <option value="B2">Težko</option>
          <option value="C1">Vesoljec</option>
        </select>
      </div>
      <div>
        <label for="direction">Smer</label>
        <select id="direction" title="Privzeto večja → manjša">
          <option value="down">Večja → manjša</option>
          <option value="up">Manjša → večja</option>
          <option value="both">Obe</option>
        </select>
      </div>
      <div>
        <button id="gen" class="primary">Ustvari 5 nalog</button>
      </div>
    </section>

    <section class="grid" id="tasks"></section>

    <section class="feedback" id="feedback">
      <span class="pill info">Cela števila brez vejice so v redu. Pika ni dovoljena.</span>
      <button id="check" disabled>Preveri</button>
      <span id="score" class="pill"></span>
    </section>
  </main>

<script>
/* ========= Utilities ========= */
const rnd = (min, max) => Math.random()*(max-min)+min;
const rndInt = (min, max) => Math.floor(rnd(min, max+1));
const pick = arr => arr[Math.floor(Math.random()*arr.length)];
const fmtComma = (n, maxDec=8) => { let s=n.toFixed(maxDec); s=s.replace(/\.?0+$/,''); return s.replace('.', ','); };
const isValidNumericInput = s => !/\./.test(s) && /^[\d,\s]+$/.test(s.trim());
const parseInput = s => Number(s.replace(/\s+/g,'').replace(',', '.'));

// ---- 8-decimal comparison helpers ----
const roundTo = (n, d = 8) => { const p = 10 ** d; return Math.round((+n + Number.EPSILON) * p) / p; };
const equal8 = (a, b) => roundTo(a, 8) === roundTo(b, 8);

/* ======= exact decimal check for TIME up-conversions ======= */
function countFactor(n, p){ let c=0; while(n%p===0){ n/=p; c++; } return [n,c]; }
function fractionDecimalsNeeded(num, den){
  const g = (a,b)=>b?g(b,a%b):Math.abs(a);
  const gg = g(num, den);
  den = den/gg;
  let a, c2; [a,c2] = countFactor(den,2);
  let b, c5; [b,c5] = countFactor(a,5);
  if(b!==1) return {terminates:false, decimals:Infinity};
  return {terminates:true, decimals:Math.max(c2,c5)};
}
function canonicalDecimalString(num, den){
  const info = fractionDecimalsNeeded(num, den);
  if(!info.terminates) return null;
  const d = info.decimals;
  const val = num/den;
  return val.toFixed(d);
}

// --- sub-1 policy (only for non-time, bigger→smaller) ---
const SUB1_POLICY = {
  A1: { min: 0.1,   max: 0.9,   decimals: 1 },
  A2: { min: 0.01,  max: 0.99,  decimals: 2 },
  B1: { min: 0.001, max: 0.999, decimals: 3 },
  B2: { min: 0.001, max: 0.999, decimals: 3 },
  C1: { min: 0.0001,max: 0.999, decimals: 3 }
};
const SUB1_PROB = 0.30; // 30%
function randWithFixed(min, max, decimals){ const scale = 10 ** decimals; return Math.round((Math.random()*(max-min)+min)*scale)/scale; }
function pickSub1Value(diff, pair){
  const pol = SUB1_POLICY[diff]; if(!pol) return null;
  if(pair && pair.multiple){
    const m = pair.multiple;
    const kMax = Math.floor((pol.max - Number.EPSILON) / m);
    const kMin = Math.ceil(pol.min / m);
    if(kMax >= kMin && kMax >= 1){ const k = rndInt(kMin, kMax); return Number((k*m).toFixed(pol.decimals)); }
  }
  return randWithFixed(pol.min, pol.max, pol.decimals);
}

/* ========= Konfiguracija (parov/smeri) ========= */
const CFG = {
  masa: { A1:{pairs:[{from:'kg',to:'g',factor:1000,dir:'both'},{from:'g',to:'mg',factor:1000,dir:'both'}], input:{min:2,max:800,decimals:[0,1]}},
          A2:{pairs:[{from:'kg',to:'g',factor:1000,dir:'both'},{from:'g',to:'mg',factor:1000,dir:'both'},{from:'kg',to:'dag',factor:100,dir:'both'},{from:'dag',to:'g',factor:10,dir:'both'},{from:'g',to:'kg',factor:1/1000,dir:'upOnly',multiple:1000}], input:{min:0.5,max:2000,decimals:[0,1,2]}},
          B1:{pairs:[{from:'t',to:'kg',factor:1000,dir:'both'},{from:'kg',to:'g',factor:1000,dir:'both'},{from:'g',to:'mg',factor:1000,dir:'both'},{from:'g',to:'μg',factor:1e6,dir:'downOnly'}], input:{min:0.1,max:10000,decimals:[0,1,2,3]}},
          B2:{pairs:[{from:'t',to:'kg',factor:1000,dir:'both'},{from:'kg',to:'mg',factor:1e6,dir:'both'},{from:'mg',to:'μg',factor:1000,dir:'both'}], input:{min:0.001,max:50000,decimals:[0,1,2,3]}},
          C1:{pairs:[{from:'kg',to:'μg',factor:1e9,dir:'downOnly'},{from:'g',to:'ng',factor:1e9,dir:'downOnly'},{from:'t',to:'g',factor:1e6,dir:'downOnly'}], input:{min:0.0001,max:10000,decimals:[0,1,2,3]}},
          base:'g' },
  dolzina:{ A1:{pairs:[{from:'m',to:'dm',factor:10,dir:'both'},{from:'m',to:'cm',factor:100,dir:'both'},{from:'cm',to:'mm',factor:10,dir:'both'},{from:'cm',to:'m',factor:1/100,dir:'upOnly',multiple:100}], input:{min:2,max:800,decimals:[0,1]}},
            A2:{pairs:[{from:'km',to:'m',factor:1000,dir:'both'},{from:'m',to:'cm',factor:100,dir:'both'},{from:'m',to:'mm',factor:1000,dir:'both'},{from:'dm',to:'cm',factor:10,dir:'both'},{from:'mm',to:'cm',factor:1/10,dir:'upOnly',multiple:10}], input:{min:0.5,max:5000,decimals:[0,1,2]}},
            B1:{pairs:[{from:'km',to:'m',factor:1000,dir:'both'},{from:'m',to:'cm',factor:100,dir:'both'},{from:'m',to:'mm',factor:1000,dir:'both'},{from:'mm',to:'μm',factor:1000,dir:'downOnly'}], input:{min:0.01,max:20000,decimals:[0,1,2,3]}},
            B2:{pairs:[{from:'km',to:'m',factor:1000,dir:'both'},{from:'m',to:'cm',factor:100,dir:'both'},{from:'cm',to:'mm',factor:10,dir:'both'},{from:'mm',to:'μm',factor:1000,dir:'both'}], input:{min:0.001,max:50000,decimals:[0,1,2,3]}},
            C1:{pairs:[{from:'km',to:'mm',factor:1e6,dir:'downOnly'},{from:'m',to:'μm',factor:1e6,dir:'downOnly'},{from:'km',to:'cm',factor:1e5,dir:'downOnly'}], input:{min:0.0001,max:20000,decimals:[0,1,2,3]}},
            base:'m'},
  povrsina:{ A1:{pairs:[{from:'m²',to:'dm²',factor:100,dir:'both'},{from:'m²',to:'cm²',factor:1e4,dir:'both'},{from:'dm²',to:'cm²',factor:100,dir:'both'}], input:{min:2,max:500,decimals:[0,1]}},
             A2:{pairs:[{from:'m²',to:'dm²',factor:100,dir:'both'},{from:'m²',to:'cm²',factor:1e4,dir:'both'},{from:'a',to:'m²',factor:100,dir:'both'},{from:'cm²',to:'m²',factor:1/1e4,dir:'upOnly',multiple:10000}], input:{min:1,max:2000,decimals:[0,1,2]}},
             B1:{pairs:[{from:'m²',to:'cm²',factor:1e4,dir:'both'},{from:'cm²',to:'mm²',factor:100,dir:'both'},{from:'ha',to:'m²',factor:10000,dir:'both'}], input:{min:0.5,max:10000,decimals:[0,1,2,3]}},
             B2:{pairs:[{from:'km²',to:'m²',factor:1e6,dir:'both'},{from:'m²',to:'cm²',factor:1e4,dir:'both'},{from:'a',to:'m²',factor:100,dir:'both'},{from:'ha',to:'m²',factor:10000,dir:'both'}], input:{min:0.01,max:50000,decimals:[0,1,2,3]}},
             C1:{pairs:[{from:'km²',to:'cm²',factor:1e10,dir:'downOnly'},{from:'m²',to:'mm²',factor:1e6,dir:'both'}], input:{min:0.001,max:20000,decimals:[0,1,2,3]}},
             base:'m²'},
  prostornina:{ A1:{pairs:[{from:'dm³',to:'L',factor:1,dir:'both'},{from:'L',to:'dL',factor:10,dir:'both'},{from:'dL',to:'cL',factor:10,dir:'both'},{from:'cL',to:'mL',factor:10,dir:'both'}], input:{min:2,max:500,decimals:[0,1]}},
               A2:{pairs:[{from:'L',to:'mL',factor:1000,dir:'both'},{from:'m³',to:'dm³',factor:1000,dir:'both'},{from:'mL',to:'L',factor:1/1000,dir:'upOnly',multiple:1000}], input:{min:1,max:2000,decimals:[0,1,2]}},
               B1:{pairs:[{from:'m³',to:'L',factor:1000,dir:'both'},{from:'cm³',to:'mL',factor:1,dir:'both'},{from:'dm³',to:'cm³',factor:1000,dir:'both'}], input:{min:0.1,max:5000,decimals:[0,1,2,3]}},
               B2:{pairs:[{from:'m³',to:'cm³',factor:1e6,dir:'both'},{from:'L',to:'μL',factor:1e6,dir:'both'}], input:{min:0.001,max:20000,decimals:[0,1,2,3]}},
               C1:{pairs:[{from:'m³',to:'mL',factor:1e6,dir:'downOnly'},{from:'L',to:'nL',factor:1e9,dir:'downOnly'},{from:'L',to:'μL',factor:1e6,dir:'downOnly'}], input:{min:0.0005,max:10000,decimals:[0,1,2,3]}},
               base:'L'},
  cas:{ A1:{pairs:[{from:'h',to:'min',factor:60,dir:'both'},{from:'min',to:'s',factor:60,dir:'both'},{from:'d',to:'h',factor:24,dir:'both'}], input:{min:1,max:200,decimals:[0]}},
        A2:{pairs:[{from:'d',to:'min',factor:1440,dir:'both'},{from:'h',to:'s',factor:3600,dir:'both'},{from:'teden',to:'d',factor:7,dir:'both'}], input:{min:1,max:100,decimals:[0]}},
        B1:{pairs:[{from:'s',to:'min',factor:1/60,dir:'both',multiple:1},{from:'min',to:'h',factor:1/60,dir:'both',multiple:1},{from:'d',to:'s',factor:86400,dir:'both'}], input:{min:10,max:10000,decimals:[0]}},
        B2:{pairs:[{from:'s',to:'h',factor:1/3600,dir:'both',multiple:1},{from:'min',to:'d',factor:1/1440,dir:'both',multiple:1},{from:'mesec(30 d)',to:'h',factor:30*24,dir:'both'}], input:{min:10,max:50000,decimals:[0]}},
        C1:{pairs:[{from:'teden',to:'min',factor:7*1440,dir:'both'},{from:'teden',to:'s',factor:7*86400,dir:'both'},{from:'leto(365 d)',to:'h',factor:365*24,dir:'both'},{from:'leto(365 d)',to:'min',factor:365*1440,dir:'both'},{from:'leto(365 d)',to:'s',factor:365*86400,dir:'both'},{from:'s',to:'d',factor:1/86400,dir:'both',multiple:1}], input:{min:10,max:200000,decimals:[0]}},
        base:'s'}
};

/* ========= Helpers for generation ========= */
function randWithDecimals(min, max, allowedDecs){
  const dec = pick(allowedDecs);
  const scale = 10 ** dec;
  const val = Math.round(rnd(min*scale, max*scale))/scale;
  return Number(val.toFixed(dec));
}
function pickPair(cat, diff, dirPref){
  // cumulative: include pairs from all lower levels too
  const order=['A1','A2','B1','B2','C1'];
  const idx=Math.max(0,order.indexOf(diff));
  const merged=[]; for(let i=0;i<=idx;i++){ const lvl=order[i]; if(CFG[cat][lvl]?.pairs) merged.push(...CFG[cat][lvl].pairs); }
  const allowed = merged.filter(p=>{
    if(dirPref==='up' && p.dir==='downOnly') return false;
    if(dirPref==='down' && p.dir==='upOnly') return false;
    return true;
  });
  return pick(allowed);
}
function chooseDirection(pair, dirPref){
  if(pair.dir==='upOnly') return {dir:'forward',factor:pair.factor};
  if(pair.dir==='downOnly') return {dir:'forward',factor:pair.factor};
  if(dirPref==='up')   return (pair.factor<1)? {dir:'forward',factor:pair.factor} : {dir:'back',factor:1/pair.factor};
  if(dirPref==='down') return (pair.factor>1)? {dir:'forward',factor:pair.factor} : {dir:'back',factor:1/pair.factor};
  const preferDown = Math.random()<0.65;
  if(preferDown) return (pair.factor>1)? {dir:'forward',factor:pair.factor} : {dir:'back',factor:1/pair.factor};
  return (pair.factor<1)? {dir:'forward',factor:pair.factor} : {dir:'back',factor:1/pair.factor};
}

/* ========= Task generation ========= */
function generateOne(cat, diff, dirPref){
  const conf = CFG[cat][diff];
  const pair = pickPair(cat, diff, dirPref);
  const dsel = chooseDirection(pair, dirPref);
  let from = pair.from, to = pair.to, factor = dsel.factor;
  if(dsel.dir==='back'){ from = pair.to; to = pair.from; }

  const forceIntTime = (cat==='cas') && (/teden|mesec|leto/.test(from));

  // decide if we try sub-1 input: only for non-time & bigger→smaller
  const trySub1 = (cat !== 'cas') && (factor > 1) && (Math.random() < SUB1_PROB);

  let x; let tries=0;
  while(true){
    if(trySub1){
      x = pickSub1Value(diff, pair);
      if(!(x>0 && x<1)) x = undefined; // fallback if invalid
    }

    if(!(x>0 && x<1)){
      if(pair.multiple){
        const m = pair.multiple||1;
        const minK = Math.ceil(conf.input.min / m);
        const maxK = Math.floor(conf.input.max / m);
        const k = rndInt(minK, Math.max(minK, maxK));
        x = k * m;
      }else if(forceIntTime){
        x = rndInt(Math.ceil(conf.input.min), Math.floor(conf.input.max));
      }else{
        x = (cat==='cas') ? rndInt(Math.ceil(conf.input.min), Math.floor(conf.input.max))
                          : randWithDecimals(conf.input.min, conf.input.max, conf.input.decimals);
      }
    }

    // TIME up-conversions: require terminating decimal <=3 places
    if(cat==='cas' && factor < 1){
      const q = Math.round(1/factor);
      const info = fractionDecimalsNeeded(x, q);
      if(!(info.terminates && info.decimals <= 3)){ if(++tries < 200){ x=undefined; continue; } }
    }

    const y = x * factor; const absY = Math.abs(y);
    if(absY!==0 && (absY>1e12 || absY<1e-9)){ if(++tries<200){ x=undefined; continue; } }
    break;
  }

  // For time up-conversions, store canonical expected string for checking
  let timeCanonical = null;
  if(cat==='cas' && factor < 1){ const q = Math.round(1/factor); timeCanonical = canonicalDecimalString(x, q); }

  return {cat,diff,from,to,x,correct:x*factor,factor,timeCanonical};
}

/* ========= Hints ========= */
function buildHint(t){
  const {from,to,factor,cat} = t;
  function unitRatio(fu, tu){
    const base = {
      'km':{'m':1000}, 'm':{'cm':100,'mm':1000,'dm':10,'μm':1e6},
      'cm':{'mm':10,'dm':0.1,'m':0.01}, 'mm':{'μm':1000,'cm':0.1,'m':0.001}, 'μm':{'mm':0.001,'m':1e-6,'cm':1e-4},
      'km²':{'m²':1e6}, 'm²':{'dm²':100,'cm²':1e4,'mm²':1e6}, 'dm²':{'cm²':100}, 'cm²':{'mm²':100},
      'a':{'m²':100}, 'ha':{'m²':10000},
      'm³':{'dm³':1000,'cm³':1e6,'L':1000}, 'dm³':{'L':1,'cm³':1000}, 'cm³':{'mL':1},
      'L':{'mL':1000,'μL':1e6,'nL':1e9}
    };
    if(base[fu] && base[fu][tu]){ const f=base[fu][tu]; return `(${f} ${tu} / 1 ${fu})`; }
    if(base[tu] && base[tu][fu]){ const f=base[tu][fu]; return `(1 ${tu} / ${f} ${fu})`; }
    return `(${factor} ${to} / 1 ${from})`;
  }
  if(cat==='cas') return `Namig: ${t.x} ${from} × ${unitRatio(from,to)}`;
  const note = (/²/.test(from)||/²/.test(to)) ? ' (kvadratni faktor)' : (/³/.test(from)||/³/.test(to)) ? ' (kubični faktor)' : '';
  return `Namig${note}: ${t.x} ${from} × ${unitRatio(from,to)}`;
}

/* ========= Render & check ========= */
let currentTasks = [];

function render(tasks){
  const host = document.getElementById('tasks'); host.innerHTML = '';
  tasks.forEach((t, idx)=>{
    const row = document.createElement('div'); row.className='row';

    const expr = document.createElement('div'); expr.className='expr';
    expr.innerHTML = `<b>${fmtComma(t.x, 3)} ${t.from}</b> <span class="eq">=</span>`;

    const input = document.createElement('input'); input.type='text'; input.className='answer';
    input.placeholder='vnesi odgovor (npr. 12,5)'; input.dataset.index=idx;

    const chip = document.createElement('div'); chip.className='chip'; chip.textContent=t.to;

    const verdict = document.createElement('span'); verdict.className='verdict'; verdict.textContent='';

    const checkOne = document.createElement('button'); checkOne.textContent='Preveri to';
    checkOne.addEventListener('click', ()=>checkSingle(idx));

    const solveBtn = document.createElement('button'); solveBtn.className='solve-btn'; solveBtn.textContent='Pokaži rešitev';

    const hint = document.createElement('details'); hint.className='hint';
    const sum = document.createElement('summary'); sum.textContent='Pokaži namig';
    const p = document.createElement('div'); p.style.marginTop='6px'; p.textContent=buildHint(t);
    hint.appendChild(sum); hint.appendChild(p);

    const solution = document.createElement('div'); solution.className='solution';
    const expectedStr = (t.cat==='cas' && t.factor<1 && t.timeCanonical)
        ? t.timeCanonical.replace('.', ',')
        : fmtComma(t.correct,8);
    solution.innerHTML = `Rešitev: <b>${expectedStr} ${t.to}</b>`;

    solveBtn.addEventListener('click', ()=>{
      solution.style.display = solution.style.display==='block' ? 'none' : 'block';
      solveBtn.textContent = solution.style.display==='block' ? 'Skrij rešitev' : 'Pokaži rešitev';
    });

    input.addEventListener('input', onAnyInputChange);

    row.appendChild(expr);
    row.appendChild(input);
    row.appendChild(chip);
    row.appendChild(verdict);
    row.appendChild(checkOne);
    row.appendChild(solveBtn);
    row.appendChild(hint);
    row.appendChild(solution);
    host.appendChild(row);
  });
}

function onAnyInputChange(){
  const inputs=[...document.querySelectorAll('input.answer')];
  const anyFilled=inputs.some(i=>i.value.trim().length>0);
  document.getElementById('check').disabled=!anyFilled;

  inputs.forEach(i=>{
    const v=i.value.trim();
    if(!v) { i.setCustomValidity(''); return; }
    if(!isValidNumericInput(v)){
      i.setCustomValidity('Uporabi samo števke in vejico (če imaš decimale). Pika ni dovoljena.');
      i.reportValidity();
    }else{
      i.setCustomValidity('');
    }
  });
}

function setVerdict(idx, ok){
  const v = document.querySelectorAll('.verdict')[idx];
  v.className = 'verdict ' + (ok ? 'ok' : 'bad');
  v.textContent = ok ? 'PRAVILNO' : 'NAPAČNO';
}

function normalizeUserDecimalString(s, needed){
  let t = s.trim().replace(/\s+/g,'').replace(',', '.');
  if(!t.includes('.')) t += '.' + '0'.repeat(needed);
  else{
    const [a,b] = t.split('.');
    const dec = b.slice(0,needed);
    t = a + '.' + dec.padEnd(needed,'0');
  }
  return t;
}

function checkSingle(idx){
  const inp = document.querySelectorAll('input.answer')[idx];
  const v = inp.value.trim();
  if(!v){ inp.style.borderColor='#2b375a'; return; }
  if(!isValidNumericInput(v)){ inp.style.borderColor='var(--bad)'; setVerdict(idx,false); return; }

  const t = currentTasks[idx];
  let ok;

  if(t.cat==='cas' && t.factor < 1 && t.timeCanonical){
    const needed = t.timeCanonical.split('.')[1]?.length || 0; // 0–3
    const userCanon = normalizeUserDecimalString(v, needed);
    ok = (userCanon === t.timeCanonical);
  }else{
    const num = parseInput(v);
    ok = equal8(num, t.correct);
  }

  inp.style.borderColor = ok ? 'var(--ok)' : 'var(--bad)';
  if(!ok){
    const expectedStr = (t.cat==='cas' && t.factor<1 && t.timeCanonical)
      ? t.timeCanonical.replace('.', ',')
      : fmtComma(t.correct,8);
    inp.title=`Pravilen rezultat: ${expectedStr} ${t.to}`;
  }
  setVerdict(idx, ok);
  updateScoreDisplay();
}

function checkAll(){
  const inputs=[...document.querySelectorAll('input.answer')];
  inputs.forEach((inp,k)=>{
    const v=inp.value.trim();
    if(!v){ inp.style.borderColor='#2b375a'; return; }
    if(!isValidNumericInput(v)){ inp.style.borderColor='var(--bad)'; setVerdict(k,false); return; }

    const t=currentTasks[k];
    let ok;
    if(t.cat==='cas' && t.factor < 1 && t.timeCanonical){
      const needed = t.timeCanonical.split('.')[1]?.length || 0;
      const userCanon = normalizeUserDecimalString(v, needed);
      ok = (userCanon === t.timeCanonical);
    }else{
      const num=parseInput(v);
      ok = equal8(num, t.correct);
    }
    inp.style.borderColor= ok ? 'var(--ok)' : 'var(--bad)';
    if(!ok){
      const expectedStr = (t.cat==='cas' && t.factor<1 && t.timeCanonical)
        ? t.timeCanonical.replace('.', ',')
        : fmtComma(t.correct,8);
      inp.title=`Pravilen rezultat: ${expectedStr} ${t.to}`;
    }
    setVerdict(k, ok);
  });
  updateScoreDisplay();
}

function updateScoreDisplay(){
  const inputs=[...document.querySelectorAll('input.answer')];
  let correct=0, answered=0;
  inputs.forEach((inp,k)=>{
    const v=inp.value.trim(); if(!v) return;
    if(!isValidNumericInput(v)) return;
    answered++;
    const t=currentTasks[k];
    let ok;
    if(t.cat==='cas' && t.factor < 1 && t.timeCanonical){
      const needed = t.timeCanonical.split('.')[1]?.length || 0;
      const userCanon = normalizeUserDecimalString(v, needed);
      ok = (userCanon === t.timeCanonical);
    }else{
      const num=parseInput(v); ok = equal8(num, t.correct);
    }
    if(ok) correct++;
  });
  const score=document.getElementById('score');
  if(answered===0){ score.className='pill'; score.textContent=''; return; }
  score.className='pill ' + (correct===answered?'ok':'bad');
  score.textContent=`Pravilnih: ${correct} / ${inputs.length}`;
}

/* ========= Wire-up ========= */
function regenerate(){
  const cat=document.getElementById('category').value;
  const diff=document.getElementById('difficulty').value;
  const dirPref=document.getElementById('direction').value;
  const N=5;

  currentTasks=[]; let safety=0;
  while(currentTasks.length<N && safety<400){
    const t=generateOne(cat,diff,dirPref);
    const key=`${t.from}>${t.to}:${t.x}`;
    if(!currentTasks.some(u=>`${u.from}>${u.to}:${u.x}`===key)) currentTasks.push(t);
    safety++;
  }
  render(currentTasks);
  document.getElementById('check').disabled=true;
  document.getElementById('score').className='pill'; document.getElementById('score').textContent='';
}

document.getElementById('gen').addEventListener('click', regenerate);
document.getElementById('direction').addEventListener('change', regenerate);
document.getElementById('check').addEventListener('click', checkAll);

regenerate();
</script>
</body>
</html>
