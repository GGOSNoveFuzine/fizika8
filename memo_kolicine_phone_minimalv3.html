<!doctype html>
<html lang="sl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spomin na SI – 4 segmenti (1/2 igralca, 4/7 količin)</title>
<meta name="description" content="Igra spomina s 4 segmenti: količina, simbol, enota SI, merilna naprava. Težavnost 4 ali 7 osnovnih količin. Način: 1 ali 2 igralca. Vključeni zvočni in vizualni učinki." />
<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --line:#233044;
    --ok:#22c55e; --bad:#ef4444; --hint:#60a5fa; --active:#3b82f6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;
    background: radial-gradient(1200px 600px at 20% -10%,#1f2a4a 0%,#0b1220 45%,#070b16 100%);
    color:var(--text); padding:16px; display:flex; gap:16px; flex-direction:column; align-items:center;
  }
  header{width:100%; max-width:1120px; display:flex; justify-content:space-between; gap:12px; align-items:center; flex-wrap:wrap}
  h1{margin:0; font-size:clamp(18px,2.6vw,28px)}
  .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .group{display:flex; gap:6px; padding:4px; border:1px solid var(--line); border-radius:12px; background:#0a1220}
  .btn, .toggle{
    background:#0b1220; border:1px solid var(--line); color:var(--text);
    padding:8px 12px; border-radius:10px; font-weight:600; letter-spacing:.2px; cursor:pointer;
  }
  .btn:hover, .toggle:hover{border-color:#3b4b66}
  .toggle[aria-pressed="true"]{border-color:var(--active); box-shadow:0 0 0 2px rgba(59,130,246,.25) inset}

  .stats{width:100%; max-width:1120px; display:flex; gap:8px; flex-wrap:wrap; color:var(--muted)}
  .stat{padding:6px 10px; border:1px solid var(--line); border-radius:10px; background:#08101e}
  .stat strong{color:#fff}
  .turn{border-color:#3b82f6; box-shadow:0 0 0 1px rgba(59,130,246,.3) inset}

  .wrap{width:100%; max-width:1120px; display:grid; gap:12px; grid-template-columns: repeat(4, 1fr)}
  @media (max-width:980px){ .wrap{grid-template-columns: repeat(2,1fr)} }
  @media (max-width:640px){ .wrap{grid-template-columns: 1fr} }

  .segment{
    background: linear-gradient(180deg,#0f172a,#0b1220); border:1px solid var(--line); border-radius:14px; padding:12px;
    display:flex; flex-direction:column; gap:10px; min-height:320px;
  }
  .seg-head{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .seg-title{font-weight:800; letter-spacing:.3px; color:#cbd5e1}
  .seg-info{font-size:12px; color:#94a3b8}
  .cards{display:grid; grid-template-columns:1fr; gap:8px; min-height:120px}

  /* card + flip */
  .card{position:relative; height:112px; perspective:800px; cursor:pointer}
  @media (min-width:1100px){ .card{height:120px} }
  .inner{position:absolute; inset:0; transition:transform .4s; transform-style:preserve-3d}
  .card.hidden .inner{transform:rotateY(0deg)}
  .card.revealed .inner{transform:rotateY(180deg)}
  .face,.back{
    position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; backface-visibility:hidden;
    border-radius:12px; padding:10px;
  }
  .back{background:#1e293b; color:#e2e8f0; border:1px solid #16314a; font-weight:800; font-size:24px}
  .face{
    transform:rotateY(180deg);
    background:linear-gradient(180deg,#0f172a,#0c1526);
    border:1px solid #334155;
  }
  .face .top{display:flex; justify-content:space-between; width:100%; font-size:12px; color:#b6c2d1}
  .face .main{
    font-size: clamp(18px, 2.3vw, 22px);
    font-weight:900;
    color:#ffffff;
    letter-spacing:.2px;
    margin-top:4px;
    text-shadow: 0 1px 2px rgba(0,0,0,.45);
  }
  .face .sub{font-size:12px; color:#9fb3c8; margin-top:2px}

  .card.selected .face{outline:2px solid var(--hint)}
  .card.bad .face{outline:2px solid var(--bad); animation: shake .32s linear}
  @keyframes shake{
    0%,100%{transform:translateX(0)}
    20%{transform:translateX(-4px)}
    40%{transform:translateX(4px)}
    60%{transform:translateX(-3px)}
    80%{transform:translateX(3px)}
  }

  /* Matched – ostanejo vidne, obarvane po skupinah */
  .card.matched{pointer-events:none}
  .card.matched .back{opacity:.2}
  .card.matched .face{color:#fff; border-color:transparent}
  .card.matched .face .top{color:rgba(255,255,255,.85)}
  .card.matched .face .sub{color:rgba(255,255,255,.9)}
  .card.matched[data-group="dolzina"] .face{background:linear-gradient(180deg, rgba(139,92,246,.25), rgba(139,92,246,.15)); box-shadow:0 0 0 2px rgba(139,92,246,.55) inset}
  .card.matched[data-group="masa"] .face{background:linear-gradient(180deg, rgba(6,182,212,.25), rgba(6,182,212,.15)); box-shadow:0 0 0 2px rgba(6,182,212,.55) inset}
  .card.matched[data-group="cas"] .face{background:linear-gradient(180deg, rgba(34,197,94,.25), rgba(34,197,94,.15)); box-shadow:0 0 0 2px rgba(34,197,94,.55) inset}
  .card.matched[data-group="temperatura"] .face{background:linear-gradient(180deg, rgba(249,115,22,.25), rgba(249,115,22,.15)); box-shadow:0 0 0 2px rgba(249,115,22,.55) inset}
  .card.matched[data-group="kolicina_snovi"] .face{background:linear-gradient(180deg, rgba(234,179,8,.28), rgba(234,179,8,.17)); box-shadow:0 0 0 2px rgba(234,179,8,.60) inset}
  .card.matched[data-group="tok"] .face{background:linear-gradient(180deg, rgba(59,130,246,.28), rgba(59,130,246,.17)); box-shadow:0 0 0 2px rgba(59,130,246,.60) inset}
  .card.matched[data-group="svetlobna"] .face{background:linear-gradient(180deg, rgba(239,68,68,.28), rgba(239,68,68,.17)); box-shadow:0 0 0 2px rgba(239,68,68,.60) inset}

  /* win modal */
  .overlay{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:16px; z-index:50}
  .overlay.show{display:flex}
  .dialog{width:min(560px,96%); background:#0b1220; border:1px solid var(--line); border-radius:16px; padding:18px}
  .dialog h2{margin:0 0 8px}
  .winner{margin-top:8px; font-weight:800}

  /* ⚡ Flash overlay (menjava igralca / zmaga) */
  .flash{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:60;
    pointer-events:none;
  }
  .flash.show{display:flex; animation: fadeFlash .9s ease forwards}
  .flash .bubble{
    background: rgba(10, 18, 32, 0.85);
    border: 2px solid #3b82f6;
    border-radius: 16px;
    padding: 16px 28px;
    font-size: clamp(28px,4vw,44px);
    font-weight: 900;
    letter-spacing: .5px;
    text-shadow: 0 2px 8px rgba(0,0,0,.4);
  }
  .flash.win .bubble{
    border-color: #22c55e;
  }
  @keyframes fadeFlash{
    0%{opacity:0; transform: scale(.96)}
    10%{opacity:1; transform: scale(1)}
    80%{opacity:1}
    100%{opacity:0}
  }

/* === CSS-only responsive enhancements (no JS) === */
:root{
  --card-pad: 14px;
  --card-radius: 12px;
  --gap: 14px;
  --seg-margin: 18px;
  --face-size: clamp(15px, 1.8vw, 18px);
  --sub-size: clamp(12px, 1.5vw, 14px);
  --btn-size: clamp(14px, 1.6vw, 16px);
}

/* Keep desktop as-is; improve small screens */
@media (max-width: 900px){
  .cards{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; }
  .card{ padding: var(--card-pad); border-radius: var(--card-radius); min-height: clamp(60px, 12vw, 96px); }
  .card .main{ font-size: var(--face-size); line-height: 1.15; }
  .card .sub { font-size: var(--sub-size); opacity: .85; }
  .segment{ margin-block: 12px; }
  .controls button, .controls .btn{ font-size: var(--btn-size); padding: clamp(8px, 1.4vw, 12px) clamp(12px, 2vw, 16px); }
  .dialog{ width: min(92vw, 560px); margin: 0 auto; }
}
@media (max-width: 420px){
  .card{ min-height: 64px; }
}

/* Prefer reduced motion */
@media (prefers-reduced-motion: reduce){
  * { animation-duration: .01ms !important; animation-iteration-count: 1 !important; transition-duration: .01ms !important; }
}

/* === Phone-minimal mode (auto via media queries) === */
@media (max-width: 900px){
  /* Make cards tiny and show only the primary line */
  .card{ padding: 8px !important; min-height: 48px !important; }
  .card .sub, .card .hint, .card .notes, .card small{ display: none !important; }
  .card .main{ 
    font-size: clamp(14px, 4vw, 18px) !important; 
    line-height: 1.15 !important; 
    white-space: normal !important; 
  }
  /* Segment spacing and grid */
  .segment{ margin-block: 10px !important; }
  .cards{ grid-template-columns: repeat(2, minmax(0,1fr)) !important; gap: 8px !important; }
  /* Buttons compact */
  .controls button, .controls .btn{ 
    font-size: clamp(12px, 3.4vw, 14px) !important; 
    padding: 6px 10px !important; 
  }
  /* Dialog compact width */
  .dialog{ width: min(94vw, 520px) !important; }
}

/* Extra-compact on very small phones */
@media (max-width: 420px){
  .cards{ grid-template-columns: repeat(3, minmax(0,1fr)) !important; gap: 6px !important; }
  .card{ min-height: 44px !important; padding: 6px !important; }
  .card .main{ font-size: clamp(12px, 4.2vw, 16px) !important; }
}
</style>
<style>
/* === Patch: phone-minimal shows ONLY the main text on cards === */
@media (max-width: 900px){
  .card .top{ display: none !important; }
  .card .sub{ display: none !important; }
  .card .main{ 
    font-size: clamp(14px, 4vw, 18px) !important;
    line-height: 1.15 !important;
    white-space: normal !important;
  }
}
@media (max-width: 420px){
  .card .main{ font-size: clamp(12px, 4.2vw, 16px) !important; }
}
</style><style>
/* === Ultra-compact phone tuning (smaller cards) === */
@media (max-width: 900px){
  .cards{ grid-template-columns: repeat(3, minmax(0,1fr)) !important; gap: 6px !important; }
  .card{ min-height: 40px !important; padding: 6px !important; }
  .card .main{ font-size: clamp(11px, 3.6vw, 14px) !important; line-height: 1.05 !important; }
}
@media (max-width: 600px){
  .cards{ grid-template-columns: repeat(4, minmax(0,1fr)) !important; gap: 5px !important; }
  .card{ min-height: 36px !important; padding: 5px !important; }
  .card .main{ font-size: clamp(10px, 3.2vw, 13px) !important; }
  .seg-head{ display: none !important; } /* hide segment headers to save vertical space */
}
@media (max-width: 380px){
  .cards{ grid-template-columns: repeat(5, minmax(0,1fr)) !important; gap: 4px !important; }
  .card{ min-height: 32px !important; padding: 4px !important; }
  .card .main{ font-size: clamp(9px, 2.9vw, 12px) !important; }
}
</style></head>
<body>
<header>
  <h1>Spomin na SI – 4 segmenti</h1>
  <div class="controls">
    <div class="group" role="group" aria-label="Način igre">
      <button id="soloBtn" class="toggle" aria-pressed="true" title="1 igralec">1 igralec</button>
      <button id="pvpBtn"  class="toggle" aria-pressed="false" title="2 igralca">2 igralca</button>
    </div>
    <div class="group" role="group" aria-label="Težavnost">
      <button id="easyBtn" class="toggle" aria-pressed="true" title="4 osnovne količine">Lahka · 4</button>
      <button id="hardBtn" class="toggle" aria-pressed="false" title="7 osnovnih količin">Težka · 7</button>
    </div>
    <!-- ⬇️ PREMEŠAJ -->
    <button id="resetBtn" class="btn">🔄 PREMEŠAJ</button>
  </div>
</header>

<div class="stats" role="status" aria-live="polite">
  <span class="stat">⏱️ Čas: <strong id="time">0:00</strong></span>
  <span class="stat">🎯 Poskusi (izbira 4): <strong id="moves">0</strong></span>
  <span class="stat">✅ Najdeni kompleti: <strong id="found">0</strong>/<strong id="total">4</strong></span>
  <span id="p1" class="stat">🟦 Igralec 1: <strong id="score1">0</strong></span>
  <span id="p2" class="stat">🟪 Igralec 2: <strong id="score2">0</strong></span>
  <span id="turn" class="stat turn" style="display:none">Na potezi: <strong id="turnName">Igralec 1</strong></span>
</div>

<div class="wrap" id="wrap"></div>

<!-- ZMAGA -->
<div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="winTitle">
  <div class="dialog">
    <h2 id="winTitle">Konec igre 🎉</h2>
    <p>Poskusi: <strong id="wMoves">0</strong> · Čas: <strong id="wTime">0:00</strong></p>
    <p id="wScores" style="margin:.4rem 0 0 0;"></p>
    <p id="wWinner" class="winner"></p>
    <div style="display:flex; gap:8px; margin-top:12px">
      <button id="againBtn" class="btn">Igraj znova</button>
      <button id="closeBtn" class="btn">Zapri</button>
    </div>
  </div>
</div>

<!-- 🔊 Fallback audio (zamenjaj src, če želiš svoje datoteke) -->
<audio id="audSwitch" preload="auto"></audio>
<audio id="audWin" preload="auto"></audio>

<!-- ⚡ Flash overlay -->
<div id="flash" class="flash"><div class="bubble" id="flashText">IGRALEC 1</div></div>

<script>
window.addEventListener('DOMContentLoaded', () => {
/* ======= KONFIG ======= */
const TYPES  = ['kolicina','simbol','enota','naprava'];
const GROUPS_EASY = ['dolzina','masa','cas','temperatura'];
const GROUPS_HARD = ['dolzina','masa','cas','temperatura','kolicina_snovi','tok','svetlobna'];

/* ======= PODATKI (7×4) ======= */
const DATA = [
  {group:'dolzina', type:'kolicina', label:'Fizikalna količina', main:'Dolžina', sub:'Razdalja med točkama'},
  {group:'dolzina', type:'simbol',   label:'Simbol', main:'l', sub:'Simbol za dolžino'},
  {group:'dolzina', type:'enota',    label:'Enota SI', main:'m', sub:'meter'},
  {group:'dolzina', type:'naprava',  label:'Merilna naprava', main:'Merilni trak / meter', sub:'merjenje dolžine'},
  {group:'masa', type:'kolicina', label:'Fizikalna količina', main:'Masa', sub:'Koliko snovi je v telesu'},
  {group:'masa', type:'simbol',   label:'Simbol', main:'m', sub:'Simbol za maso'},
  {group:'masa', type:'enota',    label:'Enota SI', main:'kg', sub:'kilogram'},
  {group:'masa', type:'naprava',  label:'Merilna naprava', main:'Tehtnica', sub:'merjenje mase'},
  {group:'cas', type:'kolicina', label:'Fizikalna količina', main:'Čas', sub:'Trajanje dogodka'},
  {group:'cas', type:'simbol',   label:'Simbol', main:'t', sub:'Simbol za čas'},
  {group:'cas', type:'enota',    label:'Enota SI', main:'s', sub:'sekunda'},
  {group:'cas', type:'naprava',  label:'Merilna naprava', main:'Ura / štoparica', sub:'merjenje časa'},
  {group:'temperatura', type:'kolicina', label:'Fizikalna količina', main:'Temperatura', sub:'Toplotno stanje'},
  {group:'temperatura', type:'simbol',   label:'Simbol', main:'T', sub:'Simbol za temperaturo'},
  {group:'temperatura', type:'enota',    label:'Enota SI', main:'K', sub:'kelvin'},
  {group:'temperatura', type:'naprava',  label:'Merilna naprava', main:'Termometer', sub:'merjenje temperature'},
  {group:'kolicina_snovi', type:'kolicina', label:'Fizikalna količina', main:'Količina snovi', sub:'Število delcev'},
  {group:'kolicina_snovi', type:'simbol',   label:'Simbol', main:'n', sub:'Simbol za količino snovi'},
  {group:'kolicina_snovi', type:'enota',    label:'Enota SI', main:'mol', sub:'mol'},
  {group:'kolicina_snovi', type:'naprava',  label:'Merilna naprava', main:'Analitična tehtnica', sub:'posredno iz mase in molske mase'},
  {group:'tok', type:'kolicina', label:'Fizikalna količina', main:'Električni tok', sub:'Pretok naboja'},
  {group:'tok', type:'simbol',   label:'Simbol', main:'I', sub:'Simbol za električni tok'},
  {group:'tok', type:'enota',    label:'Enota SI', main:'A', sub:'amper'},
  {group:'tok', type:'naprava',  label:'Merilna naprava', main:'Ampermeter', sub:'merjenje toka'},
  {group:'svetlobna', type:'kolicina', label:'Fizikalna količina', main:'Svetlobna jakost', sub:'Jakost svetlobnega vira'},
  {group:'svetlobna', type:'simbol',   label:'Simbol', main:'Iᵥ', sub:'Simbol za svetlobno jakost'},
  {group:'svetlobna', type:'enota',    label:'Enota SI', main:'cd', sub:'candela'},
  {group:'svetlobna', type:'naprava',  label:'Merilna naprava', main:'Fotometer', sub:'merjenje svetlobne jakosti'},
];

/* ======= STANJE ======= */
let mode = 'easy';      // 'easy' | 'hard'
let players = 'solo';   // 'solo' | 'pvp'
let currentPlayer = 1;  // 1 or 2
let score1 = 0, score2 = 0;

let selections = {};      // {kolicina: btn, simbol: btn, enota: btn, naprava: btn}
let found = 0, moves = 0, secs = 0, timer = null, lock = false;

const els = {
  wrap: document.getElementById('wrap'),
  time: document.getElementById('time'),
  moves: document.getElementById('moves'),
  found: document.getElementById('found'),
  total: document.getElementById('total'),
  reset: document.getElementById('resetBtn'),
  overlay: document.getElementById('overlay'),
  wMoves: document.getElementById('wMoves'),
  wTime: document.getElementById('wTime'),
  wScores: document.getElementById('wScores'),
  wWinner: document.getElementById('wWinner'),
  again: document.getElementById('againBtn'),
  close: document.getElementById('closeBtn'),
  easyBtn: document.getElementById('easyBtn'),
  hardBtn: document.getElementById('hardBtn'),
  soloBtn: document.getElementById('soloBtn'),
  pvpBtn:  document.getElementById('pvpBtn'),
  p1: document.getElementById('p1'),
  p2: document.getElementById('p2'),
  score1: document.getElementById('score1'),
  score2: document.getElementById('score2'),
  turn: document.getElementById('turn'),
  turnName: document.getElementById('turnName'),
  flash: document.getElementById('flash'),
  flashText: document.getElementById('flashText'),
  audSwitch: document.getElementById('audSwitch'),
  audWin: document.getElementById('audWin'),
};

/* ======= AUDIO ======= */
/* WebAudio: kratek beep za menjavo, mini-fanfara za zmago */
let actx = null;
function ensureAudio(){ if(!actx){ actx = new (window.AudioContext||window.webkitAudioContext)(); } }
function beep(freq=660, dur=140, type='sine', vol=0.2){
  try{
    ensureAudio();
    const o=actx.createOscillator(), g=actx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=vol;
    o.connect(g); g.connect(actx.destination);
    o.start(); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, actx.currentTime+0.12); o.stop(actx.currentTime+0.13);}, dur);
  }catch(e){ /* fallback <audio> if provided */ els.audSwitch.currentTime=0; els.audSwitch.play().catch(()=>{}); }
}
function fanfare(){
  try{
    ensureAudio();
    const now = actx.currentTime;
    const seq = [523,659,784]; // C5-E5-G5
    seq.forEach((f,i)=>{
      const o=actx.createOscillator(), g=actx.createGain();
      o.type='triangle'; o.frequency.value=f; g.gain.value=0.18;
      o.connect(g); g.connect(actx.destination);
      const t=now+i*0.15; o.start(t); o.stop(t+0.18);
    });
  }catch(e){
    els.audWin.currentTime=0; els.audWin.play().catch(()=>{});
  }
}

/* ======= FLASH (vizualni napis) ======= */
let flashTimer = null;
function showFlash(text, isWin=false){
  els.flashText.textContent = text;
  els.flash.classList.toggle('win', !!isWin);
  els.flash.classList.add('show');
  clearTimeout(flashTimer);
  flashTimer = setTimeout(()=> els.flash.classList.remove('show'), isWin ? 1400 : 900);
}

/* ======= POMOŽNE ======= */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
const pad = n=>n.toString().padStart(2,'0');
const fmt = s => `${Math.floor(s/60)}:${pad(s%60)}`;
function startTimer(){ if(timer) return; timer = setInterval(()=>{ secs++; els.time.textContent=fmt(secs); }, 1000); }
function titleFor(type){ return {kolicina:'1) Fizikalna količina', simbol:'2) Simbol', enota:'3) Enota SI', naprava:'4) Merilna naprava'}[type] || type; }
function shortForGroup(g){ return { dolzina:'dolžina', masa:'masa', cas:'čas', temperatura:'T', kolicina_snovi:'mol', tok:'tok', svetlobna:'svetl. jakost' }[g] || g; }
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function currentGroups(){ return mode==='easy' ? GROUPS_EASY : GROUPS_HARD; }
function filteredDataBy(type){
  const allowed = new Set(currentGroups());
  return DATA.filter(d => d.type===type && allowed.has(d.group));
}
function updateTurnUI(){
  if(players==='pvp'){
    els.turn.style.display = '';
    els.turnName.textContent = currentPlayer===1 ? 'Igralec 1' : 'Igralec 2';
    els.p1.classList.toggle('turn', currentPlayer===1);
    els.p2.classList.toggle('turn', currentPlayer===2);
  }else{
    els.turn.style.display = 'none';
    els.p1.style.display = 'none';
    els.p2.style.display = 'none';
  }
}

/* ======= RISANJE ======= */
function buildBoard(){
  els.wrap.innerHTML = '';
  ['kolicina','simbol','enota','naprava'].forEach(type=>{
    const cards = shuffle(filteredDataBy(type).map((c,i)=>({...c, id:`${type}-${i}`})));
    const seg = document.createElement('section');
    seg.className = 'segment';
    seg.setAttribute('data-type', type);
    seg.innerHTML = `
      <div class="seg-head">
        <div class="seg-title">${titleFor(type)}</div>
        <div class="seg-info">Izberi 1</div>
      </div>
      <div class="cards"></div>
    `;
    const list = seg.querySelector('.cards');

    if(cards.length === 0){
      const warn = document.createElement('div');
      warn.textContent = 'Ni kartic (preveri filter skupin).';
      warn.style.color = '#fca5a5';
      warn.style.fontSize = '12px';
      list.appendChild(warn);
    }

    cards.forEach(c=>{
      const b = document.createElement('button');
      b.className = 'card hidden';
      b.dataset.type = type;
      b.dataset.group = c.group;
      b.dataset.id = c.id;
      b.innerHTML = `
        <div class="inner">
          <div class="back">?</div>
          <div class="face">
            <div class="top"><span>${c.label}</span><span>(${shortForGroup(c.group)})</span></div>
            <div class="main">${escapeHtml(c.main)}</div>
            <div class="sub">${escapeHtml(c.sub)}</div>
          </div>
        </div>
      `;
      b.addEventListener('click', ()=> onSelect(b));
      list.appendChild(b);
    });
    els.wrap.appendChild(seg);
  });
}

function flipUp(btn){ btn.classList.remove('hidden'); btn.classList.add('revealed','selected'); }
function flipDown(btn){ btn.classList.remove('revealed','selected','bad'); btn.classList.add('hidden'); }

/* ======= LOGIKA ======= */
function onSelect(btn){
  if(lock) return;
  if(btn.getAttribute('aria-disabled')==='true') return;

  startTimer();

  const type = btn.dataset.type;
  if(selections[type]) return; // en pick na segment v tem krogu

  flipUp(btn);
  selections[type] = btn;

  if(Object.keys(selections).length === 4){
    lock = true;
    setTimeout(checkMatch, 250);
  }
}

function checkMatch(){
  moves++; els.moves.textContent = moves;

  const picks = ['kolicina','simbol','enota','naprava'].map(t => selections[t]);
  const groups = new Set(picks.map(p => p.dataset.group));
  const success = groups.size === 1;

  if(success){
    picks.forEach(p => {
      p.classList.add('matched');
      p.classList.remove('selected');
      p.setAttribute('aria-disabled','true');
    });
    if(players==='pvp'){
      if(currentPlayer===1){ score1++; els.score1.textContent = score1; }
      else{ score2++; els.score2.textContent = score2; }
    }
    found++; els.found.textContent = `${found}`;
    selections = {};
    lock = false;

    if(found === currentGroups().length){
      clearInterval(timer); timer = null;
      // vizual + zvok zmage (kdo je zmagal v PVP?)
      if(players==='pvp'){
        const msg = (score1>score2) ? 'ZMAGA! IGRALEC 1' : (score2>score1 ? 'ZMAGA! IGRALEC 2' : 'NEODLOČENO!');
        showFlash(msg, true);
      }else{
        showFlash('ZMAGA!', true);
      }
      fanfare();
      showWin();
    }
    // v PVP: pravilen set → igralec ostane na potezi

  }else{
    picks.forEach(p => p.classList.add('bad'));
    setTimeout(()=>{
      picks.forEach(p => flipDown(p));
      selections = {};
      if(players==='pvp'){
        currentPlayer = currentPlayer===1 ? 2 : 1; // menjava ob napaki
        updateTurnUI();
        showFlash(currentPlayer===1 ? 'IGRALEC 1' : 'IGRALEC 2');
        beep(660,130,'square',0.22);
      }
      lock = false;
    }, 800);
  }
}

/* ======= UI ======= */
function showWin(){
  els.wMoves.textContent = moves;
  els.wTime.textContent = fmt(secs);
  if(players==='pvp'){
    els.wScores.textContent = `Rezultat – Igralec 1: ${score1}, Igralec 2: ${score2}`;
    let winner = '';
    if(score1 > score2) winner = 'Zmagal je Igralec 1 🎉';
    else if(score2 > score1) winner = 'Zmagal je Igralec 2 🎉';
    else winner = 'Neodločeno 🤝';
    els.wWinner.textContent = winner;
  }else{
    els.wScores.textContent = '';
    els.wWinner.textContent = '';
  }
  els.overlay.classList.add('show');
}
function hideWin(){ els.overlay.classList.remove('show'); }

function setPlayers(modePlayers){
  players = modePlayers; // 'solo' | 'pvp'
  document.getElementById('soloBtn').setAttribute('aria-pressed', players==='solo' ? 'true' : 'false');
  document.getElementById('pvpBtn').setAttribute('aria-pressed',  players==='pvp'  ? 'true' : 'false');
  // pokaži/skrij player stats
  document.getElementById('p1').style.display = players==='pvp' ? '' : 'none';
  document.getElementById('p2').style.display = players==='pvp' ? '' : 'none';
  els.turn.style.display = players==='pvp' ? '' : 'none';
  resetGame(); // nova igra v izbranem načinu
}

function applyMode(newMode){
  mode = newMode; // 'easy' | 'hard'
  document.getElementById('easyBtn').setAttribute('aria-pressed', mode==='easy' ? 'true' : 'false');
  document.getElementById('hardBtn').setAttribute('aria-pressed', mode==='hard' ? 'true' : 'false');
  resetGame();
}

function resetGame(){
  hideWin();
  selections = {}; found = 0; moves = 0; secs = 0; lock = false;
  currentPlayer = 1; score1 = 0; score2 = 0;
  els.time.textContent='0:00'; els.moves.textContent='0';
  els.total.textContent = currentGroups().length;
  els.found.textContent = '0';
  els.score1.textContent = '0'; els.score2.textContent = '0';
  updateTurnUI();
  if(timer){ clearInterval(timer); timer=null; }
  buildBoard();
}

/* ======= ZAGON ======= */
document.getElementById('resetBtn').addEventListener('click', resetGame);
document.getElementById('againBtn').addEventListener('click', resetGame);
document.getElementById('closeBtn').addEventListener('click', hideWin);

document.getElementById('easyBtn').addEventListener('click', ()=> applyMode('easy'));
document.getElementById('hardBtn').addEventListener('click', ()=> applyMode('hard'));
document.getElementById('soloBtn').addEventListener('click', ()=> setPlayers('solo'));
document.getElementById('pvpBtn').addEventListener('click',  ()=> setPlayers('pvp'));

/* Init */
setPlayers('solo');   // reset & ui
applyMode('easy');    // reset & totals
}); // DOMContentLoaded
</script>
</body>
</html>
